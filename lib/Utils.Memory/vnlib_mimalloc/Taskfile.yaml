# https://taskfile.dev

#Called by the vnbuild system to produce builds for my website
#https://www.vaughnnugent.com/resources/software

#This taskfile is called in this directory and is specific to the vnlib_mimalloc project
#that handles the MSBuild outside of the solution file

version: '3'

vars:
  DEP_NAME: 'mimalloc'
  PROJECT_NAME: '{{ .PROJECT_NAME | default "vnlib_mimalloc" }}'
  BINARY_DIR: '{{ .BINARY_DIR | default "bin" }}'
  ARTIFACT_DIR: '{{ .USER_WORKING_DIR }}/{{ .BINARY_DIR }}'

  # optional build variables
  ENABLE_GREEDY: '{{ .ENABLE_GREEDY | default "1" }}'       # default to greedy allocator build

  # default cmake build parameters
  CMAKE_BUILD_TYPE: '{{ .BUILD_TYPE | default "Release" }}'
  CMAKE_BUILD_DIR: 'build/{{ OS }}'

tasks:

  default:
    desc: "Builds the entire project from source code without using the VNBuild build system for target machines"
    requires:
      vars: [CMAKE_BUILD_DIR, CMAKE_BUILD_TYPE, PROJECT_NAME]
    cmds:
     - cmd: echo "Building {{ .PROJECT_NAME }} in mode {{ .CMAKE_BUILD_TYPE }}"
       silent: true
     
     - task: cmake-build
       vars:
         CMAKE_BUILD_DIR: '{{ .CMAKE_BUILD_DIR }}'
         CMAKE_BUILD_TYPE: '{{ .CMAKE_BUILD_TYPE }}'
         CMAKE_ARGS: '{{ .CLI_ARGS }} {{ .CMAKE_ARGS }}'

     - cmd: echo -e "\033[0;32mYour {{ .PROJECT_NAME }} library files can be found in {{ .USER_WORKING_DIR }}/{{ .CMAKE_BUILD_DIR }}\033[0m"
       silent: true

  debug:
    desc: 'Builds the library for the current platform in debug mode'
    cmds:
     - task: default
       vars: 
         CMAKE_BUILD_DIR: '{{ .CMAKE_BUILD_DIR }}'
         CMAKE_BUILD_TYPE: "debug" 
         CMAKE_ARGS: '{{ .CMAKE_ARGS }}'

  cmake-configure:
    desc: 'Configures the build for the current platform'
    internal: true
    requires:
      vars: [CMAKE_BUILD_DIR, CMAKE_BUILD_TYPE, ENABLE_GREEDY]
    cmds:
      - cmd: cmake 
         {{ .CMAKE_ARGS }} 
         -S .
         -B{{ .CMAKE_BUILD_DIR }}
         -DCMAKE_BUILD_TYPE={{ .CMAKE_BUILD_TYPE }}
         -DENABLE_GREEDY={{ .ENABLE_GREEDY }}

  cmake-compile:
    desc: 'Compiles the project for the current platform'
    internal: true
    requires:
      vars: [CMAKE_BUILD_DIR]
    cmds:
     - cmd: cmake --build {{ .CMAKE_BUILD_DIR }}/ --config debug
     - cmd: cmake --build {{ .CMAKE_BUILD_DIR }}/ --config release

  cmake-build:
    desc: 'Runs the cmake generate and build commands as a single task'
    internal: true
    requires:
      vars: [CMAKE_BUILD_DIR, CMAKE_BUILD_TYPE, CMAKE_ARGS]
    cmds:
      - task: cmake-configure
        vars:
          CMAKE_BUILD_DIR: '{{ .CMAKE_BUILD_DIR }}'
          CMAKE_BUILD_TYPE: '{{ .CMAKE_BUILD_TYPE }}'
          CMAKE_ARGS: '{{ .CMAKE_ARGS }}'
   
      - task: cmake-compile
        vars:
          CMAKE_BUILD_DIR: '{{ .CMAKE_BUILD_DIR }}'

  #called by ci pipline to build the winx64 project
  build:
    desc: 'DO NOT USE. This is an internal task'
    requires:
      vars: [CMAKE_BUILD_DIR, CMAKE_BUILD_TYPE]
    cmds:
     - task: cmake-build
       vars:
         CMAKE_BUILD_DIR: '{{ .CMAKE_BUILD_DIR }}'
         CMAKE_BUILD_TYPE: '{{ .CMAKE_BUILD_TYPE }}'
         CMAKE_ARGS: '
           {{ .CLI_ARGS }}
           {{ if eq OS "windows" }}-G "Visual Studio 17 2022"{{ end }}
           {{ if eq OS "windows" }}-A x64{{ end }}'

  postbuild_success:
    desc: 'DO NOT USE. This is an internal task'
    requires:
      vars: [ARTIFACT_DIR]
    cmds:
     - cmd: mkdir -p '{{ .ARTIFACT_DIR }}'
       ignore_error: true

     - task: pack-parallel
  
  pack-parallel:
    desc: 'Packs the binary artifacts into tar files for distribution for various builds in parallel'
    internal: true
    deps:
     - task: pack-source

     - task: pack-dist
       vars: { BUILD_MODE: 'debug' }
     - task: pack-dist
       vars: { BUILD_MODE: 'release' }

  pack-dist:
    desc: 'Packs the binary artifacts into a tar file for distribution'  
    internal: true
    requires:
      vars: [ARTIFACT_DIR, BUILD_MODE, PROJECT_NAME]
    vars:
      TARGET_DIR: '{{ .CMAKE_BUILD_DIR }}/{{ .BUILD_MODE }}'
      ARCHIVE_PATH: '{{ .ARTIFACT_DIR }}/msvc-x64-{{ .BUILD_MODE }}-{{ .PROJECT_NAME }}.tgz'
    cmds:
     - cmd: cp NativeHeapApi.h '{{ .TARGET_DIR }}/'
     - cmd: cp vendor/license '{{ .TARGET_DIR }}/{{ .DEP_NAME }}_license.txt'
     - cmd: cp license '{{ .TARGET_DIR }}/license.txt'
     - cmd: cp build.readme.txt '{{ .TARGET_DIR }}/readme.txt'

     - cmd: cd {{ .TARGET_DIR }} && tar{{ if eq OS "windows" }}.exe{{ end }} -czf '{{ .ARCHIVE_PATH }}' .

  pack-source:
    desc: 'Packs the source code into a tar file for distribution' 
    internal: true
    requires:
      vars: [ARTIFACT_DIR, PROJECT_NAME]
    vars:
      TARGET_SOURCE: '{{ .ARTIFACT_DIR }}/src.tgz'
      SOURCE_FILES: 
        CMakeLists.txt
        Taskfile.yaml
        vendor
        LICENSE
        NativeHeapApi.h
        '{{ .PROJECT_NAME }}.c'

    cmds:
     # tar up the source
     - cmd: tar{{ if eq OS "windows" }}.exe{{ end }} -czf '{{ .TARGET_SOURCE }}' {{ .SOURCE_FILES | join " " }}

  dev-init:
    desc: 'Configures the project for local development'
    cmds:
     - task: debug
     - cmd: echo "dev init complete"
       silent: true

  clean:
    desc: 'Cleans any build artifacts and output directories'
    ignore_error: true
    cmds:
     - for: [ bin/, build/ ]
       cmd: rm -rf "{{ .ITEM }}"
