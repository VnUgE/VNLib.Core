# https://taskfile.dev

#Called by the vnbuild system to produce builds for my website
#https://www.vaughnnugent.com/resources/software

#This taskfile is specific to this project, since it must be compiled on the target platform
#this simply packs the source code into a tgz file for download

version: '3'

vars:
  THIRD_PARTY_DIR: '../third-party'
  PROJECT_NAME: 'vnlib_compress'

tasks:

  default:
    cmds:
     - cmd: echo "Building vnlib_compress"
       silent: true

     #make dirs on non-win
     - cmd: mkdir {{.THIRD_PARTY_DIR}}
       platforms: ['linux', 'darwin']

     #make dirs on windows
     - cmd: powershell -Command "mkdir {{.THIRD_PARTY_DIR}} -Force"
       platforms: ['windows']

     #clone libs
     - cmd: cd {{.THIRD_PARTY_DIR}} && git clone https://github.com/cloudflare/zlib.git
       ignore_error: true

     - cmd: cd {{.THIRD_PARTY_DIR}} && git clone https://github.com/google/brotli.git
       ignore_error: true
 
     #invoke cmake for build
     - cmake -B./build -DCMAKE_BUILD_TYPE=RELEASE {{.CMAKE_ARGS}}
 
     #build for Windows
     - cmd: cd build && msbuild {{.PROJECT_NAME}}.sln /p:Configuration=release {{.BUILD_FLAGS}}
       platforms: ['windows']

     #using make
     - cmd: cd build && make
       platforms: ['linux', 'darwin']
          

  #when build succeeds, archive the output into a tgz 
  postbuild_success:
    cmds:
     - cmd: powershell mkdir -Force './bin'
     #copy source code to target
     - powershell -Command "tar --exclude build/* --exclude .vs/* --exclude bin/* -czvf bin/src.tgz ."

  postbuild_failed:
    cmds: []

#Remove the output dirs on clean
  clean:
    ignore_error: true
    cmds:
     - cmd: powershell Remove-Item -Recurse './bin'
