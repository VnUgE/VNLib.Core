# https://taskfile.dev

#Called by the vnbuild system to produce builds for my website
#https://www.vaughnnugent.com/resources/software

#This taskfile is specific to this project, since it must be compiled on the target platform
#this simply packs the source code into a tgz file for download

version: '3'

vars:
  THIRD_PARTY_DIR: '../third-party'
  PROJECT_NAME: 'vnlib_compress'

tasks:

  default:
    cmds:
     - cmd: echo "Building vnlib_compress"
       silent: true
    
    #make third-party dir before cloning libs
     - cmd: powershell -Command "mkdir '{{.THIRD_PARTY_DIR}}' -Force"
       ignore_error: true  

     - task: zlib
     - task: brotli
 
     #invoke cmake for build
     - cmake -B./build {{.CMAKE_ARGS}}
 
     #build for platform
     - cmake --build build/ --config Release
          

  #when build succeeds, archive the output into a tgz 
  postbuild_success:
    cmds:
     - cmd: powershell mkdir -Force './bin'
     #copy source code to target
     - powershell -Command "tar --exclude build/* --exclude .vs/* --exclude bin/* -czf bin/src.tgz ."

#Remove the output dirs on clean
  clean:
    ignore_error: true
    cmds:
     - cmd: powershell Remove-Item -Recurse './bin'

  #update or install the cloudflare fork of zlib library 
  zlib:
    internal: true
    status:
     - cd {{.THIRD_PARTY_DIR}} && git clone https://github.com/cloudflare/zlib.git

    cmds:
     - cd {{.THIRD_PARTY_DIR}}/zlib && git pull
  
  #update or install the google brotli library
  brotli:
    internal: true
    status:
     - cd {{.THIRD_PARTY_DIR}} && git clone https://github.com/google/brotli.git  
    cmds:
     - cd {{.THIRD_PARTY_DIR}}/brotli && git pull
    